<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>ãƒ•ãƒ©ãƒƒã‚·ãƒ¥æ•°å­—è¨˜æ†¶ã‚²ãƒ¼ãƒ </title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    /* ==========
       å…¨ä½“ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ
       ========== */
    :root{
      --card-width: 840px;
      --theme-grad-1: #6a11cb; /* ç´« */
      --theme-grad-2: #2575fc; /* é’ */
      --ok: #16a34a;          /* æˆåŠŸï¼ˆç·‘ï¼‰ */
      --ng: #dc2626;          /* å¤±æ•—ï¼ˆèµ¤ï¼‰ */
      --muted: #9ca3af;       /* ã‚°ãƒ¬ãƒ¼ */
      --ink: #1f2937;         /* æ–‡å­—è‰²ï¼ˆæ¿ƒã„ã‚ï¼‰ */
      --ink-light: #4b5563;   /* æ–‡å­—è‰²ï¼ˆè–„ã‚ï¼‰ */
      --border: #e5e7eb;      /* ç½«ç·š */
      --shadow: 0 8px 24px rgba(0,0,0,0.15);
      --shadow-soft: 0 4px 12px rgba(0,0,0,0.12);
      --radius: 16px;
      --radius-sm: 10px;
      --accent: #7c3aed;      /* ã‚¢ã‚¯ã‚»ãƒ³ãƒˆï¼ˆç´«ï¼‰ */
    }

    html, body {
      height: 100%;
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Noto Sans JP, "Hiragino Kaku Gothic ProN", "Meiryo", "Yu Gothic UI", "Yu Gothic", sans-serif;
      color: var(--ink);
    }

    /* èƒŒæ™¯ã®ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ */
    body {
      background: linear-gradient(135deg, var(--theme-grad-1), var(--theme-grad-2));
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* ä¸­å¤®ã®ã‚«ãƒ¼ãƒ‰ */
    .card {
      width: min(95vw, var(--card-width));
      background: #fff;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 24px 28px 16px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    /* ãƒ˜ãƒƒãƒ€éƒ¨åˆ†ï¼ˆã‚¿ã‚¤ãƒˆãƒ« + è¨­å®š/æ“ä½œï¼‰ */
    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      flex-wrap: wrap;
    }

    .title {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .title h1 {
      font-size: 1.4rem;
      font-weight: 700;
      margin: 0;
      letter-spacing: .02em;
    }

    .title .badge {
      font-size: .82rem;
      color: #fff;
      background: var(--accent);
      padding: 4px 10px;
      border-radius: 999px;
      font-weight: 600;
    }

    /* è¨­å®šï¼ˆé›£æ˜“åº¦ + ã‚¹ã‚¿ãƒ¼ãƒˆï¼‰ */
    .controls {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    label {
      font-size: .95rem;
      color: var(--ink-light);
    }

    select, button {
      appearance: none;
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      padding: 10px 12px;
      font-size: .95rem;
      background: #fff;
      cursor: pointer;
      transition: transform .06s ease, box-shadow .2s ease, background .2s ease, color .2s ease, opacity .2s ease;
    }

    select:focus, button:focus {
      outline: 3px solid rgba(124, 58, 237, .2);
      border-color: var(--accent);
    }

    .btn {
      background: var(--accent);
      color: #fff;
      border-color: transparent;
      font-weight: 700;
      box-shadow: var(--shadow-soft);
    }

    .btn:hover { transform: translateY(-1px); }
    .btn:active { transform: translateY(0); }

    .btn-secondary {
      background: #fff;
      color: var(--ink);
      border-color: var(--border);
      font-weight: 700;
    }

    .btn-secondary:hover { box-shadow: var(--shadow-soft); transform: translateY(-1px); }
    .btn:disabled, .btn-secondary:disabled, select:disabled {
      opacity: .6;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    /* è¡¨ç¤ºã‚¨ãƒªã‚¢ï¼ˆã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ï¼ãƒ•ãƒ©ãƒƒã‚·ãƒ¥æ•°å­—ï¼çµæœï¼‰ */
    .display {
      position: relative;
      min-height: 260px;
      border: 1px dashed var(--border);
      border-radius: var(--radius);
      display: flex;
      align-items: center;
      justify-content: center;
      background: #fafafa;
      overflow: hidden;
    }

    .big-text {
      font-size: clamp(4rem, 10vw, 8rem); /* ãƒ•ãƒ©ãƒƒã‚·ãƒ¥æ•°å­—ã¯å¤§ãã */
      font-weight: 800;
      color: var(--ink);
      letter-spacing: .03em;
      user-select: none;
      line-height: 1;
      opacity: 0;
      transform: scale(.9);
      /* æœ€åˆã¯éè¡¨ç¤ºã€‚JSå´ã§ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ç”¨ã‚¯ãƒ©ã‚¹ã‚’ä»˜ã‘å¤–ã—ã—ã¦è¡¨ç¤º */
    }

    /* æ•°å­—ã®ãƒãƒƒãƒ—ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆæ‹¡å¤§ã—ã¤ã¤ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¤ãƒ³ï¼‰ */
    @keyframes popIn {
      0%   { transform: scale(.6); opacity: 0; }
      60%  { transform: scale(1.06); opacity: 1; }
      100% { transform: scale(1); }
    }
    .pop {
      animation: popIn .28s ease-out forwards;
    }

    /* çµæœè¡¨ç¤ºï¼ˆæˆåŠŸ/å¤±æ•—ã®èƒŒæ™¯è‰²ã‚’åˆ‡ã‚Šæ›¿ãˆï¼‰ */
    .result {
      position: absolute;
      inset: 0;
      display: none; /* åˆæœŸã¯éè¡¨ç¤ºã€‚åˆ¤å®šå¾Œã«è¡¨ç¤º */
      align-items: center;
      justify-content: center;
      text-align: center;
      padding: 24px;
      color: #fff;
    }
    .result.success { display: flex; background: linear-gradient(180deg, rgba(22,163,74,.96), rgba(22,163,74,.88)); }
    .result.fail    { display: flex; background: linear-gradient(180deg, rgba(220,38,38,.96), rgba(220,38,38,.88)); }

    .result .result-inner {
      max-width: 640px;
    }
    .result h2 {
      margin: 0 0 6px 0;
      font-size: clamp(1.2rem, 3vw, 1.6rem);
    }
    .result p {
      margin: 6px 0;
      font-size: .98rem;
      opacity: .98;
    }
    .seq {
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
      background: rgba(255,255,255,.15);
      padding: 6px 8px;
      border-radius: 8px;
      display: inline-block;
    }

    /* å…¥åŠ›ã¨ãƒœã‚¿ãƒ³é ˜åŸŸ */
    .input-area {
      display: none; /* åˆæœŸã¯éè¡¨ç¤ºã€‚æ•°å­—æç¤ºå¾Œã«è¡¨ç¤º */
      flex-direction: column;
      gap: 10px;
    }

    .input-label {
      color: var(--ink-light);
      font-size: .95rem;
    }

    .user-seq {
      min-height: 28px;
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      padding: 8px 10px;
      background: #fff;
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
      color: var(--ink);
    }

    /* 3Ã—3 ã‚°ãƒªãƒƒãƒ‰ã®æ•°å­—ãƒœã‚¿ãƒ³ */
    .grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
    }

    .num-btn {
      height: 64px;
      font-size: 1.2rem;
      font-weight: 800;
      border-radius: 12px;
      background: #f8fafc;
      border: 1px solid var(--border);
      box-shadow: 0 1px 0 rgba(0,0,0,.02);
    }
    .num-btn:hover { transform: translateY(-2px); box-shadow: var(--shadow-soft); background: #ffffff; }
    .num-btn:active { transform: translateY(0); }
    .num-btn:disabled {
      background: #f3f4f6;
      color: var(--muted);
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    /* ä¸‹éƒ¨ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒãƒ¼ï¼ˆé€£ç¶šæˆåŠŸãƒ»æœ€é«˜è¨˜éŒ²ãƒ»æ­£è§£ç‡ï¼‰ */
    .statusbar {
      border-top: 1px solid var(--border);
      margin-top: 4px;
      padding-top: 12px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 12px;
      color: var(--ink-light);
      font-size: .95rem;
    }
    .stat-group {
      display: flex;
      gap: 16px;
      align-items: center;
      flex-wrap: wrap;
    }
    .stat {
      background: #f8fafc;
      border: 1px solid var(--border);
      border-radius: 999px;
      padding: 6px 10px;
    }

    /* è£œåŠ©ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ */
    .note {
      color: var(--ink-light);
      font-size: .9rem;
    }
  </style>
</head>
<body>
  <main class="card" role="main" aria-labelledby="title">
    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ï¼šã‚¿ã‚¤ãƒˆãƒ«ã¨ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« -->
    <div class="header">
      <div class="title">
        <h1 id="title">ãƒ•ãƒ©ãƒƒã‚·ãƒ¥æ•°å­—è¨˜æ†¶ã‚²ãƒ¼ãƒ </h1>
        <span class="badge">1ãƒ•ã‚¡ã‚¤ãƒ« / ãƒ©ã‚¤ãƒ–ãƒ©ãƒªä¸ä½¿ç”¨</span>
      </div>
      <div class="controls">
        <label for="difficulty">é›£æ˜“åº¦ï¼š</label>
        <select id="difficulty" aria-label="é›£æ˜“åº¦é¸æŠ">
          <option value="easy">ç°¡å˜ï¼ˆ3å€‹ / è¡¨ç¤º1.0ç§’ï¼‰</option>
          <option value="normal" selected>æ™®é€šï¼ˆ5å€‹ / è¡¨ç¤º0.7ç§’ï¼‰</option>
          <option value="hard">é›£ã—ã„ï¼ˆ7å€‹ / è¡¨ç¤º0.5ç§’ï¼‰</option>
          <option value="insane">è¶…é›£ã—ã„ï¼ˆ9å€‹ / è¡¨ç¤º0.4ç§’ï¼‰</option>
        </select>
        <button id="startBtn" class="btn" aria-label="ã‚²ãƒ¼ãƒ é–‹å§‹">ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
        <button id="retryBtn" class="btn-secondary" disabled aria-label="ã‚‚ã†ä¸€åº¦">ã‚‚ã†ä¸€åº¦</button>
        <button id="resetBtn" class="btn-secondary" aria-label="çµ‚äº†ï¼ˆãƒªã‚»ãƒƒãƒˆï¼‰">çµ‚äº†</button>
      </div>
    </div>

    <!-- è¡¨ç¤ºé ˜åŸŸï¼ˆã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ï¼ãƒ•ãƒ©ãƒƒã‚·ãƒ¥æ•°å­—ï¼çµæœï¼‰ -->
    <section class="display" aria-live="polite">
      <!-- ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³/ãƒ•ãƒ©ãƒƒã‚·ãƒ¥æ•°å­— -->
      <div id="bigText" class="big-text" aria-hidden="true">3</div>

      <!-- åˆ¤å®šçµæœã®ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
      <div id="resultOverlay" class="result" aria-live="assertive">
        <div class="result-inner">
          <h2 id="resultTitle">ğŸ‰ æ­£è§£ï¼</h2>
          <p id="resultMessage">ãŠè¦‹äº‹ï¼</p>
          <p><strong>æ­£è§£ã®é †ç•ªï¼š</strong> <span id="resultCorrect" class="seq"></span></p>
          <p id="resultUserWrap" style="display:none;"><strong>ã‚ãªãŸã®å›ç­”ï¼š</strong> <span id="resultUser" class="seq"></span></p>
          <p id="streakInfo" class="note"></p>
        </div>
      </div>
    </section>

    <!-- å…¥åŠ›ã‚¨ãƒªã‚¢ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ãƒœã‚¿ãƒ³ï¼‰ -->
    <section class="input-area" id="inputArea">
      <div class="input-label">ã‚¯ãƒªãƒƒã‚¯ã—ãŸé †ç•ªï¼š</div>
      <div id="userSeq" class="user-seq" aria-live="polite">ï¼ˆæœªå…¥åŠ›ï¼‰</div>

      <div class="grid" id="grid">
        <!-- 1ã€œ9ã®ãƒœã‚¿ãƒ³ã¯JSã§ç”Ÿæˆ -->
      </div>
    </section>

    <!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒãƒ¼ï¼šå¸¸æ™‚è¡¨ç¤º -->
    <footer class="statusbar" aria-live="polite">
      <div class="stat-group">
        <div class="stat">é€£ç¶šæˆåŠŸï¼š<strong id="streak">0</strong></div>
        <div class="stat">æœ€é«˜è¨˜éŒ²ï¼š<strong id="best">0</strong></div>
        <div class="stat">æ­£è§£ç‡ï¼š<strong id="accuracy">0%</strong></div>
      </div>
      <div class="note">â‘ ã‚¹ã‚¿ãƒ¼ãƒˆ â†’ â‘¡ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ â†’ â‘¢æ•°å­—ãŒé †ç•ªã«è¡¨ç¤º â†’ â‘£åŒã˜é †ç•ªã§ä¸‹ã®ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯</div>
    </footer>
  </main>

  <script>
    /* =========================================================
       ãƒ•ãƒ©ãƒƒã‚·ãƒ¥æ•°å­—è¨˜æ†¶ã‚²ãƒ¼ãƒ ï¼ˆVanilla JSï¼‰
       ï¼ï¼ åˆå­¦è€…å‘ã‘ã«æ—¥æœ¬èªã‚³ãƒ¡ãƒ³ãƒˆã‚’ä¸å¯§ã«è¨˜è¼‰ ï¼ï¼
       ========================================================= */

    // ------------------------------------------
    // é›£æ˜“åº¦ã”ã¨ã®è¨­å®šï¼ˆè¡¨ç¤ºå€‹æ•°ã¨è¡¨ç¤ºæ™‚é–“ï¼‰
    // ------------------------------------------
    const difficultySettings = {
      // ç°¡å˜ï¼š3å€‹ãƒ»1.0ç§’ã”ã¨ã«è¡¨ç¤º
      easy:   { count: 3,  interval: 1000 },
      // æ™®é€šï¼š5å€‹ãƒ»0.7ç§’ã”ã¨ã«è¡¨ç¤º
      normal: { count: 5,  interval: 700  },
      // é›£ã—ã„ï¼š7å€‹ãƒ»0.5ç§’ã”ã¨ã«è¡¨ç¤º
      hard:   { count: 7,  interval: 500  },
      // è¶…é›£ã—ã„ï¼š9å€‹ãƒ»0.4ç§’ã”ã¨ã«è¡¨ç¤º
      insane: { count: 9,  interval: 400  },
    };

    // ------------------------------------------
    // å‚ç…§ã™ã‚‹DOMè¦ç´ ã‚’ã¾ã¨ã‚ã¦å–å¾—
    // ------------------------------------------
    const difficultySelect = document.getElementById('difficulty');
    const startBtn         = document.getElementById('startBtn');
    const retryBtn         = document.getElementById('retryBtn');
    const resetBtn         = document.getElementById('resetBtn');

    const displayArea      = document.querySelector('.display');
    const bigText          = document.getElementById('bigText');
    const resultOverlay    = document.getElementById('resultOverlay');
    const resultTitle      = document.getElementById('resultTitle');
    const resultMessage    = document.getElementById('resultMessage');
    const resultCorrect    = document.getElementById('resultCorrect');
    const resultUserWrap   = document.getElementById('resultUserWrap');
    const resultUser       = document.getElementById('resultUser');
    const streakInfo       = document.getElementById('streakInfo');

    const inputArea        = document.getElementById('inputArea');
    const userSeqBox       = document.getElementById('userSeq');
    const grid             = document.getElementById('grid');

    const streakEl         = document.getElementById('streak');
    const bestEl           = document.getElementById('best');
    const accuracyEl       = document.getElementById('accuracy');

    // ------------------------------------------
    // ã‚²ãƒ¼ãƒ çŠ¶æ…‹ã‚’ä¿æŒã™ã‚‹å¤‰æ•°ï¼ˆåˆæœŸå€¤ï¼‰
    // ------------------------------------------
    let correctSequence = [];     // æ­£è§£ã®é †ç•ªï¼ˆä¾‹ï¼š[3,7,2,...]ï¼‰
    let userSequence    = [];     // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å…¥åŠ›é †ç•ª
    let isPlaying       = false;  // æ•°å­—æç¤ºä¸­ã‚„å›ç­”ä¸­ã«äºŒé‡é–‹å§‹ã‚’é˜²ããƒ•ãƒ©ã‚°
    let showTimerId     = null;   // setInterval ã®IDã‚’ä¿æŒï¼ˆåœæ­¢ç”¨ï¼‰

    // çµ±è¨ˆï¼ˆç”»é¢ä¸‹éƒ¨ã«å¸¸æ™‚è¡¨ç¤ºï¼‰
    let streak          = 0;      // é€£ç¶šæˆåŠŸå›æ•°
    let best            = 0;      // æœ€é«˜è¨˜éŒ²ï¼ˆæœ€å¤§é€£ç¶šæˆåŠŸï¼‰
    let totalGames      = 0;      // è©¦è¡Œå›æ•°
    let totalCorrect    = 0;      // æ­£è§£å›æ•°

    // ------------------------------------------
    // åˆæœŸåŒ–ï¼š1ã€œ9ã®ãƒœã‚¿ãƒ³ã‚’3Ã—3ã‚°ãƒªãƒƒãƒ‰ã«é…ç½®
    // ------------------------------------------
    function buildGridButtons() {
      grid.innerHTML = '';
      for (let n = 1; n <= 9; n++) {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'num-btn';
        btn.textContent = String(n);
        btn.setAttribute('aria-label', `æ•°å­— ${n}`);
        btn.addEventListener('click', () => selectNumber(n, btn));
        grid.appendChild(btn);
      }
    }
    buildGridButtons();

    // ------------------------------------------
    // ã‚²ãƒ¼ãƒ é–‹å§‹ï¼šé›£æ˜“åº¦å–å¾— â†’ ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ â†’ æ•°å­—æç¤º
    // ------------------------------------------
    function startGame() {
      if (isPlaying) return; // å¤šé‡èµ·å‹•é˜²æ­¢

      // UIã®æº–å‚™
      clearResultOverlay();
      inputArea.style.display = 'none';
      userSequence = [];
      updateUserSequenceView();

      // ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«é¡ã®æœ‰åŠ¹/ç„¡åŠ¹åˆ‡ã‚Šæ›¿ãˆ
      isPlaying = true;
      startBtn.disabled = true;
      retryBtn.disabled = true;
      difficultySelect.disabled = true;

      // æ­£è§£ã®é †ç•ªã‚’ç”Ÿæˆ
      const { count } = getCurrentDifficulty();
      correctSequence = generateSequence(count);

      // 3ç§’ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ â†’ æ•°å­—æç¤º
      runCountdown(3).then(() => {
        showNumberSequence();
      });
    }

    // ------------------------------------------
    // ç¾åœ¨é¸æŠã•ã‚Œã¦ã„ã‚‹é›£æ˜“åº¦è¨­å®šã‚’è¿”ã™
    // ------------------------------------------
    function getCurrentDifficulty() {
      const key = difficultySelect.value;
      return difficultySettings[key];
    }

    // ------------------------------------------
    // 1ã€œ9ã‹ã‚‰é‡è¤‡ãªã—ã§ count å€‹ã®æ•°å­—ã‚’ãƒ©ãƒ³ãƒ€ãƒ å–å¾—
    // ï¼ˆé…åˆ—ã‚·ãƒ£ãƒƒãƒ•ãƒ« â†’ å…ˆé ­ã‹ã‚‰ count å€‹ã‚’åˆ‡ã‚Šå‡ºã™ï¼‰
    // ------------------------------------------
    function generateSequence(count) {
      const digits = [1,2,3,4,5,6,7,8,9];
      // ãƒ•ã‚£ãƒƒã‚·ãƒ£ãƒ¼â€“ã‚¤ã‚§ãƒ¼ãƒ„ã®ã‚·ãƒ£ãƒƒãƒ•ãƒ«
      for (let i = digits.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [digits[i], digits[j]] = [digits[j], digits[i]];
      }
      return digits.slice(0, count);
    }

    // ------------------------------------------
    // 3,2,1 ã®ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ã‚’å¤§ããè¡¨ç¤ºï¼ˆç´„1ç§’é–“éš”ï¼‰
    // Promise ã§å®Œäº†å¾Œã« then ã§ç¶šãã®å‡¦ç†ã¸
    // ------------------------------------------
    function runCountdown(seconds) {
      return new Promise((resolve) => {
        let remain = seconds;
        bigText.textContent = remain;
        bigText.classList.remove('pop');
        void bigText.offsetWidth; // ãƒªãƒ•ãƒ­ãƒ¼ã—ã¦ã‹ã‚‰
        bigText.classList.add('pop');
        bigText.style.opacity = 1;

        const timer = setInterval(() => {
          remain -= 1;
          if (remain <= 0) {
            clearInterval(timer);
            // æœ€å¾Œã«ã€Œã‚¹ã‚¿ãƒ¼ãƒˆï¼ã€ãªã©ã‚’è¡¨ç¤ºã—ã¦ã‚‚OKã€‚ã“ã“ã§ã¯ä¸€ç¬ç©ºç™½ã«ã€‚
            bigText.style.opacity = 0;
            resolve();
          } else {
            bigText.textContent = remain;
            bigText.classList.remove('pop');
            void bigText.offsetWidth; // ãƒªãƒ•ãƒ­ãƒ¼
            bigText.classList.add('pop');
          }
        }, 1000);
      });
    }

    // ------------------------------------------
    // æ•°å­—ã®æç¤ºï¼šè¨­å®šã•ã‚ŒãŸé–“éš”ã§1ã¤ãšã¤è¡¨ç¤ºï¼ˆsetIntervalï¼‰
    // è¡¨ç¤ºãŒçµ‚ã‚ã£ãŸã‚‰å…¥åŠ›ã‚¨ãƒªã‚¢ã‚’è¡¨ç¤º
    // ------------------------------------------
    function showNumberSequence() {
      const { interval } = getCurrentDifficulty();

      let idx = 0;
      bigText.style.opacity = 1; // è¡¨ç¤ºã‚¨ãƒªã‚¢ã‚’è¦‹ã›ã‚‹
      showTimerId = setInterval(() => {
        if (idx >= correctSequence.length) {
          // ã™ã¹ã¦è¡¨ç¤ºã—çµ‚ã‚ã£ãŸã‚‰çµ‚äº†å‡¦ç†
          clearInterval(showTimerId);
          showTimerId = null;
          // æ•°å­—ã‚¨ãƒªã‚¢ã¯æ¶ˆã™
          bigText.style.opacity = 0;
          // å…¥åŠ›ã‚¨ãƒªã‚¢ã‚’è¡¨ç¤º
          prepareForAnswer();
          return;
        }

        // ç¾åœ¨ã®æ•°å­—ã‚’å¤§ããè¡¨ç¤º + ãƒãƒƒãƒ—ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
        const n = correctSequence[idx];
        bigText.textContent = String(n);
        bigText.classList.remove('pop');
        void bigText.offsetWidth; // ãƒªãƒ•ãƒ­ãƒ¼
        bigText.classList.add('pop');

        idx += 1;
      }, interval);
    }

    // ------------------------------------------
    // å›ç­”å—ä»˜ã®æº–å‚™ï¼šå…¥åŠ›ã‚¨ãƒªã‚¢è¡¨ç¤ºï¼†ãƒœã‚¿ãƒ³æœ‰åŠ¹åŒ–
    // ------------------------------------------
    function prepareForAnswer() {
      inputArea.style.display = 'flex';
      // ã™ã¹ã¦ã®æ•°å­—ãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–
      Array.from(grid.querySelectorAll('button')).forEach(btn => {
        btn.disabled = false;
      });
      // å†ãƒ—ãƒ¬ã‚¤ãƒœã‚¿ãƒ³ã¯ã“ã®æ™‚ç‚¹ã§æœ‰åŠ¹åŒ–ï¼ˆé€”ä¸­ã§ã‚„ã‚Šç›´ã—ãŸã„å ´åˆå‘ã‘ï¼‰
      retryBtn.disabled = false;
    }

    // ------------------------------------------
    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ•°å­—ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸã¨ãã®å‡¦ç†
    // - é…åˆ—ã«è¿½åŠ 
    // - ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–ï¼ˆå†ã‚¯ãƒªãƒƒã‚¯é˜²æ­¢ï¼‰
    // - æ—¢å®šã®å€‹æ•°ã«é”ã—ãŸã‚‰è‡ªå‹•åˆ¤å®š
    // ------------------------------------------
    function selectNumber(n, btnEl) {
      // æ•°å­—è¡¨ç¤ºä¸­ã¯ã‚¯ãƒªãƒƒã‚¯ã‚’ç„¡è¦–ï¼ˆé€šå¸¸ã“ã®çŠ¶æ…‹ã§ã¯ inputArea ãŒéè¡¨ç¤ºï¼‰
      if (!inputArea.style.display || inputArea.style.display === 'none') return;

      userSequence.push(n);
      btnEl.disabled = true; // ã‚°ãƒ¬ãƒ¼ã‚¢ã‚¦ãƒˆï¼ˆå†ã‚¯ãƒªãƒƒã‚¯é˜²æ­¢ï¼‰
      updateUserSequenceView();

      if (userSequence.length >= correctSequence.length) {
        // å¿…è¦å€‹æ•°ã«é”ã—ãŸã‚‰è‡ªå‹•åˆ¤å®š
        submitAnswer();
      }
    }

    // ------------------------------------------
    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å…¥åŠ›è¡¨ç¤ºï¼ˆ"1 â†’ 5 â†’ 3" ã®ã‚ˆã†ã«è¡¨ç¤ºï¼‰
    // ------------------------------------------
    function updateUserSequenceView() {
      if (userSequence.length === 0) {
        userSeqBox.textContent = 'ï¼ˆæœªå…¥åŠ›ï¼‰';
      } else {
        userSeqBox.textContent = userSequence.join(' â†’ ');
      }
    }

    // ------------------------------------------
    // å›ç­”ã®åˆ¤å®šï¼šJSON.stringify ã§é…åˆ—ã‚’æ¯”è¼ƒ
    // - æ­£è§£ãªã‚‰ streak +1ã€æœ€é«˜è¨˜éŒ²ã‚’æ›´æ–°
    // - ä¸æ­£è§£ãªã‚‰ streak ã‚’ 0 ã«ãƒªã‚»ãƒƒãƒˆ
    // - æ­£è§£ç‡ã‚„ç·ãƒˆãƒ©ã‚¤æ•°ã‚’æ›´æ–°ã—ã€çµæœã‚’è¡¨ç¤º
    // ------------------------------------------
    function submitAnswer() {
      // å›ç­”å—ä»˜çµ‚äº†ï¼šå…¥åŠ›ãƒœã‚¿ãƒ³ã¯ä¸€æ—¦ç„¡åŠ¹åŒ–
      Array.from(grid.querySelectorAll('button')).forEach(btn => btn.disabled = true);
      inputArea.style.display = 'none';

      totalGames += 1;

      const isCorrect = JSON.stringify(userSequence) === JSON.stringify(correctSequence);
      if (isCorrect) {
        streak += 1;
        totalCorrect += 1;
        if (streak > best) best = streak;

        showResult(true, {
          correct: correctSequence,
          user: userSequence,
        });
      } else {
        streak = 0;
        showResult(false, {
          correct: correctSequence,
          user: userSequence,
        });
      }

      updateStats();
      // 1ãƒ©ã‚¦ãƒ³ãƒ‰çµ‚äº†ï¼šé–‹å§‹ãƒœã‚¿ãƒ³ã‚’å†ã³æœ‰åŠ¹åŒ–
      isPlaying = false;
      startBtn.disabled = false;
      difficultySelect.disabled = false;
      retryBtn.disabled = false;
    }

    // ------------------------------------------
    // çµæœã®è¡¨ç¤ºï¼ˆæˆåŠŸ/å¤±æ•—ï¼‰
    // - èƒŒæ™¯è‰²ã®åˆ‡ã‚Šæ›¿ãˆ
    // - æ­£è§£ã®é †ç•ªã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å›ç­”ã‚’æç¤º
    // - é€£ç¶šæˆåŠŸæƒ…å ±ã‚‚ã‚ã‚ã›ã¦è¡¨ç¤º
    // ------------------------------------------
    function showResult(success, { correct, user }) {
      resultOverlay.classList.remove('success', 'fail');

      if (success) {
        resultOverlay.classList.add('success');
        resultTitle.textContent = 'ğŸ‰ æ­£è§£ï¼';
        resultMessage.textContent = 'ãŠè¦‹äº‹ï¼å®Œç’§ã«è¨˜æ†¶ã§ãã¾ã—ãŸã€‚';
        resultUserWrap.style.display = 'none'; // æ­£è§£æ™‚ã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼å›ç­”ã®è¡¨ç¤ºã¯çœç•¥ã—ã¦ã‚‚OK
      } else {
        resultOverlay.classList.add('fail');
        resultTitle.textContent = 'âŒ æ®‹å¿µï¼';
        resultMessage.textContent = 'é †ç•ªãŒé•ã„ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã—ã¾ã—ã‚‡ã†ã€‚';
        resultUserWrap.style.display = 'block';
      }

      resultCorrect.textContent = correct.join(' â†’ ');
      resultUser.textContent = user.join(' â†’ ');
      streakInfo.textContent = `ç¾åœ¨ã®é€£ç¶šæˆåŠŸï¼š${streak} ï¼ æœ€é«˜è¨˜éŒ²ï¼š${best}`;

      resultOverlay.style.display = 'flex';
    }

    // ------------------------------------------
    // çµæœã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚’éš ã™ï¼ˆæ–°ã—ã„ã‚²ãƒ¼ãƒ å‰ãªã©ï¼‰
    // ------------------------------------------
    function clearResultOverlay() {
      resultOverlay.style.display = 'none';
      resultOverlay.classList.remove('success', 'fail');
    }

    // ------------------------------------------
    // ä¸‹éƒ¨ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ï¼ˆé€£ç¶šæˆåŠŸãƒ»æœ€é«˜è¨˜éŒ²ãƒ»æ­£è§£ç‡ï¼‰ã‚’æ›´æ–°
    // ------------------------------------------
    function updateStats() {
      streakEl.textContent = String(streak);
      bestEl.textContent   = String(best);
      const accuracy = totalGames === 0 ? 0 : Math.round((totalCorrect / totalGames) * 100);
      accuracyEl.textContent = `${accuracy}%`;
    }

    // ------------------------------------------
    // ã€Œã‚‚ã†ä¸€åº¦ã€ãƒœã‚¿ãƒ³ï¼šåŒã˜é›£æ˜“åº¦ã§å³ãƒªãƒˆãƒ©ã‚¤
    // ------------------------------------------
    function retryGame() {
      if (isPlaying) return; // è¡¨ç¤ºä¸­ã¯ä¸å¯
      startGame();
    }

    // ------------------------------------------
    // ã€Œçµ‚äº†ï¼ˆãƒªã‚»ãƒƒãƒˆï¼‰ã€ãƒœã‚¿ãƒ³ï¼šå®Œå…¨ãƒªã‚»ãƒƒãƒˆ
    // - çµ±è¨ˆã‚‚ãƒªã‚»ãƒƒãƒˆ
    // - ç”»é¢çŠ¶æ…‹ã‚’åˆæœŸåŒ–
    // ------------------------------------------
    function resetGame() {
      if (showTimerId) {
        clearInterval(showTimerId);
        showTimerId = null;
      }
      isPlaying = false;

      // çŠ¶æ…‹ã‚¯ãƒªã‚¢
      correctSequence = [];
      userSequence = [];

      // UIåˆæœŸåŒ–
      bigText.style.opacity = 0;
      clearResultOverlay();
      inputArea.style.display = 'none';
      Array.from(grid.querySelectorAll('button')).forEach(btn => btn.disabled = false);
      updateUserSequenceView();

      // ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«é¡
      startBtn.disabled = false;
      retryBtn.disabled = true; // ã¾ã ã‚²ãƒ¼ãƒ ã—ã¦ã„ãªã„ã®ã§ç„¡åŠ¹åŒ–
      difficultySelect.disabled = false;

      // çµ±è¨ˆãƒªã‚»ãƒƒãƒˆ
      streak = 0;
      best = 0;
      totalGames = 0;
      totalCorrect = 0;
      updateStats();
    }

    // ------------------------------------------
    // ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š
    // ------------------------------------------
    startBtn.addEventListener('click', startGame);
    retryBtn.addEventListener('click', retryGame);
    resetBtn.addEventListener('click', resetGame);

    // åˆæœŸã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹åæ˜ 
    updateStats();
  </script>
</body>
</html>